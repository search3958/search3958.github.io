<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>BaramCode - Flow v6</title>
    <style>
        :root {
            --bg: #ffffff; --chat-bg: #f9fafb; --accent: #111827;
            --border: #e5e7eb; --text: #374151; --text-muted: #9ca3af;
            --diff-add: #f0fdf4; --diff-rem: #fef2f2;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); }
        #app { display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; border-left: 1px solid var(--border); border-right: 1px solid var(--border); position: relative; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid var(--border); background: #fff; z-index: 10; }
        .header-title { font-weight: bold; font-size: 14px; }
        .dl-link { font-size: 12px; color: var(--text); text-decoration: none; border: 1px solid var(--border); padding: 4px 12px; border-radius: 4px; cursor: pointer; }
        .dl-link:hover { background: #f3f4f6; }

        /* Chat Feed */
        #chatFeed { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .msg { margin-bottom: 24px; }
        .bubble { padding: 14px 16px; border-radius: 8px; font-size: 14px; line-height: 1.6; }
        .user .bubble { background: var(--accent); color: #fff; margin-left: auto; max-width: 80%; white-space: pre-wrap; font-family: monospace; font-size: 11px; }
        .ai .bubble { background: #fff; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Diff Content */
        .diff-card { margin-top: 12px; background: #fff; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; font-family: monospace; }
        .diff-content { font-size: 11px; line-height: 1.4; white-space: pre; overflow-x: auto; max-height: 300px; }
        .d-row { padding: 2px 10px; display: flex; gap: 8px; }
        .d-row.add { background: var(--diff-add); color: #166534; }
        .d-row.rem { background: var(--diff-rem); color: #991b1b; }

        /* Input Area */
        .input-wrap { padding: 20px; background: #fff; border-top: 1px solid var(--border); }
        .mode-select { display: flex; gap: 6px; margin-bottom: 12px; }
        .m-btn { border: 1px solid var(--border); padding: 6px 14px; border-radius: 4px; cursor: pointer; background: #fff; font-size: 12px; transition: 0.2s; }
        .m-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        
        textarea { width: 100%; height: 110px; border: 1px solid var(--border); border-radius: 6px; padding: 12px; box-sizing: border-box; font-family: monospace; font-size: 13px; outline: none; resize: none; }
        textarea:focus { border-color: var(--accent); }
        
        .footer-ctrl { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        #status { font-size: 11px; color: var(--text-muted); font-family: monospace; }
        #sendBtn { background: var(--accent); color: #fff; border: none; padding: 8px 24px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; }
        #sendBtn:hover { opacity: 0.8; }
    </style>
</head>
<body>
<div id="app">
    <div class="header">
        <div class="header-title">BaramCode Flow v6</div>
        <button class="dl-link" onclick="downloadCode()">Download (.txt)</button>
    </div>
    
    <div id="chatFeed"></div>
    
    <div class="input-wrap">
        <div class="mode-select">
            <button id="m-patch" class="m-btn active" onclick="setMode('patch')">変更を適用</button>
            <button id="m-base" class="m-btn" onclick="setMode('base')">ベースを登録</button>
        </div>
        <textarea id="mainInput" placeholder="パッチまたはソースを入力..."></textarea>
        <div class="footer-ctrl">
            <span id="status">Base: Empty</span>
            <button id="sendBtn">送信</button>
        </div>
    </div>
</div>

<script>
    let currentSource = ""; 
    let mode = "patch";

    function setMode(m) {
        mode = m;
        document.getElementById('m-patch').classList.toggle('active', m === 'patch');
        document.getElementById('m-base').classList.toggle('active', m === 'base');
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
        const val = document.getElementById('mainInput').value.trim();
        if (!val) return;
        addChat('user', val);
        if (mode === 'base') {
            currentSource = val;
            addChat('ai', "Baseソースを更新しました。");
        } else {
            processUnifiedDiff(val);
        }
        document.getElementById('mainInput').value = "";
        document.getElementById('status').innerText = currentSource ? `Base: ${currentSource.split('\n').length} lines` : "Base: Empty";
    });

    // diffの処理ロジックは変更していません
    function processUnifiedDiff(diffText) {
        if (!currentSource) return addChat('ai', "先にソースを登録してください。");
        
        let lines = currentSource.split('\n');
        let diffLines = diffText.split('\n');
        let changes = [];
        let i = 0;

        try {
            while (i < diffLines.length) {
                if (!diffLines[i].startsWith('@@')) { i++; continue; }
                i++;

                while (i < diffLines.length && !diffLines[i].startsWith('@@')) {
                    let dLine = diffLines[i];
                    let symbol = dLine.trim()[0];
                    let content = dLine.trim().substring(1).trim();

                    if (dLine.includes('-') && symbol === '-') {
                        let foundIdx = -1;
                        for(let j=0; j<lines.length; j++) {
                            if (lines[j].trim() === content && lines[j] !== "__DELETE__") {
                                foundIdx = j; break;
                            }
                        }
                        if (foundIdx !== -1) {
                            changes.push({ type: 'rem', old: lines[foundIdx] });
                            lines[foundIdx] = "__DELETE__";
                        }
                    } else if (dLine.includes('+') && symbol === '+') {
                        let insertIdx = lines.findIndex(l => l === "__DELETE__");
                        if (insertIdx === -1) {
                            insertIdx = lines.length;
                        }
                        let newCode = dLine.trim().substring(1);
                        changes.push({ type: 'add', new: newCode });
                        lines.splice(insertIdx, 0, newCode);
                    }
                    i++;
                }
            }

            currentSource = lines.filter(l => l !== "__DELETE__").join('\n');
            if (changes.length === 0) throw new Error("マッチする行が見つかりませんでした。");
            renderResult(changes);
        } catch (e) {
            addChat('ai', "エラー: " + e.message);
        }
    }

    function renderResult(changes) {
        const div = document.createElement('div');
        div.className = 'msg ai';
        let card = `<div class="diff-card"><div class="diff-content">`;
        changes.forEach(c => {
            if (c.type === 'rem') card += `<div class="d-row rem"><span>-</span>${esc(c.old)}</div>`;
            else card += `<div class="d-row add"><span>+</span>${esc(c.new)}</div>`;
        });
        div.innerHTML = `
            <div class="bubble">
                適用完了（${changes.length}件）
                ${card}</div>
                <div style="margin-top:8px; display:flex; gap:10px;">
                    <span class="dl-link" style="font-size:11px;" onclick="downloadCode()">この状態をダウンロード</span>
                </div>
            </div>`;
        document.getElementById('chatFeed').appendChild(div);
        div.scrollIntoView();
    }

    function addChat(type, text) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `<div class="bubble">${esc(text)}</div>`;
        document.getElementById('chatFeed').appendChild(div);
        div.scrollIntoView();
    }

    function downloadCode() {
        if (!currentSource) { alert("ソースコードがありません。"); return; }
        const blob = new Blob([currentSource], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "processed_code.txt";
        a.click();
        URL.revokeObjectURL(url);
    }

    function esc(s) { return s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])) : ""; }
</script>
</body>
</html>