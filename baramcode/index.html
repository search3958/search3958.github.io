<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>BaramCode</title>
    <style>
        :root {
            --bg: #ffffff;
            --chat-bg: #f9fafb;
            --accent: #111827;
            --border: #e5e7eb;
            --text: #374151;
            --diff-add: #f0fdf4;
            --diff-rem: #fef2f2;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text);
        }

        /* レイアウト */
        #app { display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }

        /* チャットエリア */
        #chatFeed { flex: 1; overflow-y: auto; padding: 30px 20px; scroll-behavior: smooth; }
        .msg { margin-bottom: 24px; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bubble { position: relative; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.6; }
        .user .bubble { background: var(--accent); color: #fff; margin-left: auto; max-width: 80%; }
        .ai .bubble { background: var(--chat-bg); border: 1px solid var(--border); }

        /* Diffカード */
        .diff-card { margin-top: 12px; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; font-family: "SFMono-Regular", Consolas, monospace; }
        .diff-header { padding: 6px 12px; background: #fdfdfd; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #9ca3af; }
        .diff-content { padding: 8px 0; font-size: 12px; overflow-x: auto; white-space: pre; }
        .d-row { padding: 0 12px; display: flex; gap: 8px; }
        .d-row.add { background: var(--diff-add); color: #166534; }
        .d-row.rem { background: var(--diff-rem); color: #991b1b; }
        .ln { width: 25px; text-align: right; opacity: 0.4; }

        /* ボタン類 */
        .actions { display: flex; gap: 8px; margin-top: 8px; }
        .btn-sm { padding: 4px 8px; font-size: 11px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); background: #fff; color: #6b7280; transition: 0.2s; }
        .btn-sm:hover { border-color: var(--accent); color: var(--accent); }

        /* 入力エリア */
        .input-wrap { padding: 20px; background: #fff; border-top: 1px solid var(--border); }
        .mode-select { display: flex; gap: 4px; margin-bottom: 12px; background: #f3f4f6; padding: 3px; border-radius: 8px; width: fit-content; }
        .m-btn { border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; color: #6b7280; background: transparent; }
        .m-btn.active { background: #fff; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        textarea {
            width: 100%; height: 80px; border: 1px solid var(--border); border-radius: 12px;
            padding: 12px; outline: none; resize: none; font-family: inherit; transition: 0.2s; box-sizing: border-box;
        }
        textarea:focus { border-color: var(--accent); }
        .submit-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        #sendBtn { background: var(--accent); color: #fff; border: none; padding: 8px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <div id="chatFeed">
        <div class="msg ai">
            <div class="bubble">
                <b>CodeFlow Minimal</b><br>
                「新しいコード」でBaseを送信し、「変更」で差分を適用します。
            </div>
        </div>
    </div>

    <div class="input-wrap">
        <div class="mode-select">
            <button id="m-patch" class="m-btn active" onclick="setMode('patch')">変更</button>
            <button id="m-base" class="m-btn" onclick="setMode('base')">新しいコード</button>
        </div>
        <textarea id="mainInput" placeholder="ここにコードを入力..."></textarea>
        <div class="submit-row">
            <div id="status" style="font-size: 11px; color: #9ca3af;">Base: Empty</div>
            <button id="sendBtn">送信</button>
        </div>
    </div>
</div>

<script>
    const MARKER = '@@code!123123123@@';
    let currentSource = ""; 
    let mode = "patch";
    let history = [];

    function setMode(m) {
        mode = m;
        document.getElementById('m-patch').classList.toggle('active', m === 'patch');
        document.getElementById('m-base').classList.toggle('active', m === 'base');
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
        const val = document.getElementById('mainInput').value.trim();
        if (!val) return;

        addChat('user', val);
        if (mode === 'base') {
            currentSource = val;
            addChat('ai', "Baseソースを更新しました。");
        } else {
            processPatch(val);
        }
        document.getElementById('mainInput').value = "";
        updateStatus();
    });

    function processPatch(template) {
        if (!currentSource) return addChat('ai', "先にソースを登録してください。");

        let sourceLines = currentSource.split('\n');
        let parts = template.split(MARKER);
        let lastIdx = 0;
        let changes = [];

        try {
            parts.forEach((part, idx) => {
                const pLines = part.split('\n').map(l => l.trim()).filter(l => l);
                pLines.forEach(pLine => {
                    let best = { idx: -1, score: 0 };
                    for (let th = 1.0; th >= 0.4; th -= 0.1) {
                        for (let i = 0; i < sourceLines.length; i++) {
                            const sc = similarity(pLine, sourceLines[i].trim());
                            if (sc > best.score) best = { idx: i, score: sc };
                        }
                        if (best.score >= th) break;
                    }
                    if (best.idx !== -1 && best.score < 0.98) {
                        const old = sourceLines[best.idx];
                        const indent = old.match(/^\s*/)[0];
                        const updated = indent + pLine;
                        changes.push({ idx: best.idx, old, new: updated, scope: findScope(sourceLines, best.idx) });
                        sourceLines[best.idx] = updated;
                    }
                });
            });

            if (changes.length === 0) throw new Error("変更箇所を特定できませんでした。");

            const id = Date.now();
            history.push({ id, prev: currentSource });
            currentSource = sourceLines.join('\n');
            renderAiPatch(id, changes, sourceLines);

        } catch (e) {
            addChat('ai', "Error: " + e.message);
        }
    }

    function renderAiPatch(id, changes, allLines) {
        const div = document.createElement('div');
        div.className = 'msg ai';
        div.id = `msg-${id}`;
        let html = `<div class="bubble">パッチを適用しました。`;
        
        changes.forEach(c => {
            html += `<div class="diff-card">
                <div class="diff-header">${c.scope}</div>
                <div class="diff-content">`;
            for (let i = c.idx - 5; i <= c.idx + 5; i++) {
                if (i < 0 || i >= allLines.length) continue;
                if (i === c.idx) {
                    html += `<div class="d-row rem"><span class="ln">-</span>${esc(c.old)}</div>`;
                    html += `<div class="d-row add"><span class="ln">+</span>${esc(c.new)}</div>`;
                } else {
                    html += `<div class="d-row"><span class="ln">${i+1}</span>${esc(allLines[i])}</div>`;
                }
            }
            html += `</div></div>`;
        });

        html += `<div class="actions">
            <button class="btn-sm" onclick="undo(${id})">戻す</button>
            <button class="btn-sm" onclick="removeMsg(${id})">削除</button>
        </div></div>`;
        div.innerHTML = html;
        document.getElementById('chatFeed').appendChild(div);
    }

    function undo(id) {
        const h = history.find(x => x.id === id);
        if (h) {
            currentSource = h.prev;
            updateStatus();
            const btn = document.querySelector(`#msg-${id} .btn-sm`);
            btn.innerText = "戻し済み";
            btn.disabled = true;
        }
    }

    function removeMsg(id) {
        document.getElementById(`msg-${id}`).remove();
    }

    function findScope(lines, idx) {
        const patterns = [/function\s+([\w$]+)/, /([\w$]+)\s*=\s*/, /class\s+([\w$]+)/, /([.#][\w\-\s]+)\{/];
        for (let i = idx; i >= 0; i--) {
            for (let p of patterns) {
                const m = lines[i].match(p);
                if (m) return m[0].replace('{','').trim();
            }
        }
        return "Global";
    }

    function similarity(s1, s2) {
        const len = Math.max(s1.length, s2.length);
        if (len === 0) return 1.0;
        const matrix = Array.from({ length: s1.length + 1 }, (_, i) => [i]);
        for (let j = 1; j <= s2.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= s1.length; i++) {
            for (let j = 1; j <= s2.length; j++) {
                matrix[i][j] = s1[i-1] === s2[j-1] ? matrix[i-1][j-1] : Math.min(matrix[i-1][j-1], matrix[i][j-1], matrix[i-1][j]) + 1;
            }
        }
        return (len - matrix[s1.length][s2.length]) / len;
    }

    function addChat(type, text) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `<div class="bubble">${esc(text).replace(/\n/g, '<br>')}</div>`;
        document.getElementById('chatFeed').appendChild(div);
        div.scrollIntoView({ behavior: 'smooth' });
    }

    function updateStatus() { document.getElementById('status').innerText = currentSource ? `Base: ${currentSource.split('\n').length} lines` : "Base: Empty"; }
    function esc(s) { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
</script>
</body>
</html>