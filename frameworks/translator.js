class XmlTranslator{constructor(){this.currentLang = localStorage.getItem('selectedLang')|| this.getBrowserLang();this.map = new Map();}getBrowserLang(){const navLang = navigator.language;const supported = ['ja','en','zh-CN','zh-TW','ko','ko-KP'];if(supported.includes(navLang))return navLang;const shortLang = navLang.split('-')[0];const match = supported.find(s => s.startsWith(shortLang));return match || 'ja';}async init(){const scriptTag = document.currentScript;const xmlPath = scriptTag.getAttribute('data-xml');if(xmlPath)await this.load(xmlPath);}getFallbackLang(lang){const rules ={'zh-CN':'zh-TW','zh-TW':'zh-CN','ko-KP':'ko','ko':'ko-KP'};return rules[lang] || null;}async load(xmlPath){try{const response = await fetch(xmlPath);const text = await response.text();const xml = new DOMParser().parseFromString(text,"application/xml");const jaTexts ={};xml.querySelectorAll('lang[id="ja"] text').forEach(node =>{jaTexts[node.getAttribute('key')] = node.textContent.trim();});let targetLang = this.currentLang;let targetNodes = xml.querySelectorAll(`lang[id="${targetLang}"] text`);if(targetNodes.length === 0){const fallback = this.getFallbackLang(targetLang);if(fallback){const fallbackNodes = xml.querySelectorAll(`lang[id="${fallback}"] text`);if(fallbackNodes.length > 0){targetNodes = fallbackNodes;}}}targetNodes.forEach(node =>{const key = node.getAttribute('key');const translatedText = node.textContent.trim();if(jaTexts[key]){this.map.set(jaTexts[key],translatedText);}});this.translatePage();}catch(e){console.error("XML Load Error:",e);}}translatePage(){if(this.currentLang === 'ja' || this.map.size === 0){document.documentElement.lang = 'ja';return;}const walker = document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,false);let node;while(node = walker.nextNode()){const originalText = node.textContent.trim();if(this.map.has(originalText)){node.textContent = this.map.get(originalText);}}document.documentElement.lang = this.currentLang;}setLanguage(lang){localStorage.setItem('selectedLang',lang);location.reload();}}const translator = new XmlTranslator();window.addEventListener('DOMContentLoaded',()=>{translator.init();const selector = document.getElementById('lang-switch');if(selector){selector.value = translator.currentLang;selector.addEventListener('change',(e)=> translator.setLanguage(e.target.value));}});