<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>문화텏트</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--preview-h:20vh; font-family:"M PLUS 1p", system-ui,-apple-system,"Segoe UI",Roboto,'Yu Gothic',"Hiragino Kaku Gothic ProN",Meiryo,Arial}
    html,body{height:100%;margin:0;background:#060609;color:#fff;overflow:hidden}
    .screen{display:flex;flex-direction:column;width:100%;height:100vh;align-items:center;justify-content:flex-start;overflow:hidden}
    .page-current,.page-next{box-sizing:border-box;border-radius:10px;overflow:hidden;width:96%;max-width:1400px;}
    .page-current{padding:4px;display:flex;flex-direction:column;gap:6px;flex-grow:1;height:calc(100% - var(--preview-h));}
    .page-next{height:var(--preview-h);margin-bottom:4px;padding:4px;display:flex;align-items:center;justify-content:center;background:#111827;}
    .block{border-radius:6px;padding:6px;overflow:hidden}
    .block .text{width:100%;text-align:center;white-space:pre-wrap;font-weight:400;line-height:1.3}
    .blk-Orange{background:#5c2a00;color:#ffcc80;font-size:clamp(20px,4vw,36px)}
    .blk-Green{background:#0f3d1a;color:#a8f0c2;font-size:clamp(20px,4vw,36px)}
    .blk-Pink{background:#4d0d2a;color:#ffb7dc;font-size:clamp(20px,4vw,36px)}
    .blk-Text{background:#111827;color:#eaf6ff;display:flex;align-items:center;justify-content:center;font-size:clamp(28px,6vw,64px);flex-grow:1;}
    .blk-Text .text{flex-grow:1; display:flex; align-items:center; justify-content:center; height:100%;}
    .page-next .text{font-size:clamp(16px,3vw,24px)}
    .controls{position:fixed;right:12px;bottom:12px;display:flex;gap:8px;z-index:99}
    .btn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
    .meta{position:fixed;left:12px;bottom:12px;font-size:12px;opacity:.6;z-index:98}
  </style>
</head>
<body>

<div class="screen">
  <div id="pageCurrent" class="page-current" data-key></div>
  <div id="pageNext" class="page-next" aria-hidden="true"></div>
</div>

<div class="controls">
  <button id="backBtn" class="btn">◀︎ Back</button>
  <button id="nextBtn" class="btn">Next ▶︎</button>
</div>
<div class="meta">同期間隔: <span id="intervalMs">100</span>ms</div>

<script id="pages-data" type="application/json">
[{"Orange":"動画音響関係指示はここ","Green":"役者指示関係はここ","Pink":"照明関係指示はここ","Text":"セリフとシーン説明はここ"},{"Orange":"","Green":"","Pink":"","Text":"j302_イカゲーム"},{"Orange":"Change Screen [Station/駅]","Green":"[ギフン]ステージ中央・俯いて座る","Pink":"","Text":"[スカウトマン]もし、人生を変えるチャンスがあるとしたら...。やってみたいと思いませんか？(ギフンに向かって)"},{"Orange":"","Green":"","Pink":"","Text":"[ギフン]...借金まみれの俺に、都合のいイイ話があるわけ...!"},{"Orange":"","Green":"","Pink":"ALL lights OFF","Text":""},{"Orange":"","Green":"[主要な主役と一部のモブ](セリフなし)舞台登場","Pink":"","Text":""},{"Orange":"Change Screen [開始]","Green":"","Pink":"After Dialogue Lights ON","Text":""},{"Orange":"","Green":"","Pink":"","Text":"[フロントマン](登場)皆さん。ようこそ。公平な競争を行います。賞金は、456億ウォン。脱落者は即失格。つまり『死』です。"},{"Orange":"After Dialogue Screen OFF","Green":"","Pink":"After Dialogue Lights OFF","Text":""},{"Orange":"","Green":"[プレイヤー]がやがやする","Pink":"","Text":"[ギフン]うそだろ..."},{"Orange":"","Green":"","Pink":"","Text":"Scene2: Game1 だるまさんがころんだ【3分】"},{"Orange":"Change Screen [人形]","Green":"プレイヤーは並ぶ","Pink":"ALL lights ON","Text":""},{"Orange":"Change Screen [だるまさん]","Green":"","Pink":"","Text":"[フロントマン]最初のゲームは、「だるまさんがころんだ」です。制限時間内にゴールへ到達してください。動いたものは即脱落です。
"},{"Orange":"","Green":"","Pink":"","Text":"[モブA]うわぁぁぁ！(死ぬ)"},{"Orange":"","Green":"","Pink":"","Text":"[ドクス]ちっ、ただのお遊びじゃねえのかよ。俺、絶対生き残ってやる！"},{"Orange":"","Green":"","Pink":"","Text":"[ジヨン](ジヨンが手を引き、セビョクをゴール側へ。)一緒に行こう"},{"Orange":"","Green":"最後、制限時間ギリギリでギフンと数名がゴール","Pink":"Change Lights color RED","Text":""},{"Orange":"Change Scene [逼迫した音響]","Green":"","Pink":"ALL lights OFF","Text":"[ピンクマン]時間終了。生存者のみ次のゲームに進みます。"},{"Orange":"After Dialogue Screen OFF","Green":"","Pink":"After Dialogue Lights OFF","Text":"Scene3: 中間演出A"},{"Orange":"","Green":"プレイヤー主役級全員登場。ステージ上では、あぐらかいで食事を取っている雰囲気","Pink":"","Text":""},{"Orange":"Change Screen [休憩所(中間)]","Green":"","Pink":"","Text":"[ジヨン]家族いるの？"},{"Orange":"","Green":"","Pink":"","Text":"[セビョク]北に...。弟が一人...。迎えにいかなくちゃ"},{"Orange":"","Green":"セビョク：ジヨンのセリフ後頷く","Pink":"","Text":"[ジヨン]私にできること、あったら言って"},{"Orange":"","Green":"","Pink":"","Text":"[ギフン]どうして参加したんだ？"},{"Orange":"","Green":"","Pink":"","Text":"[アリ]妻と子がいます。でも、韓国では...。働いても...足りないんです。"},{"Orange":"","Green":"","Pink":"","Text":"[ギフン]お前は昔から頭が良かった...。でもこれはちがうだろ...。"},{"Orange":"","Green":"","Pink":"","Text":"[サンウ]勝たなきゃ意味がない。ここには、正解も、倫理(りんり)もないんだよ..."},{"Orange":"","Green":"","Pink":"","Text":"Scene4: Game2 綱引き【3分】"},{"Orange":"","Green":"チーム分け：主役級(ドクス除く) vs ドクス率いるモブチーム","Pink":"","Text":""},{"Orange":"Change Screen [綱引き]","Green":"","Pink":"","Text":"[イルナム]昔、村祭りで綱引きをしたことがあってねぇ...。力より心を合わせることが大事なんだ。"},{"Orange":"","Green":"","Pink":"","Text":"[ドクス]お前ら、全員弱そうだなw　今ここで全員奈落におちろ！！"},{"Orange":"","Green":"両軍：引き合う","Pink":"","Text":"[ギフン]引けぇぇ！！"},{"Orange":"","Green":"両軍：引き合う","Pink":"","Text":"[イルナム](息を切らしながら)いいか...?一歩前に出るんだ。相手がよろけたとき、一気に引け！！"},{"Orange":"","Green":"両軍：引き合う","Pink":"","Text":"[サンウ]いまだ！いけーーー！！"},{"Orange":"After Dialogue Screen OFF","Green":"","Pink":"After Dialogue Lights OFF","Text":"[ピンクマン]勝者チーム、残留。"},{"Orange":"","Green":"","Pink":"","Text":"Scene 5:中間演出B【2分程度】"},{"Orange":"Change Screen [休憩所(中間)]","Green":"暗転後、舞台下手に毛布・上手にVIP観覧してる感じ","Pink":"準備完了後:All lights ON","Text":""},{"Orange":"","Green":"","Pink":"","Text":"[ジヨン]...。眠れる?"},{"Orange":"","Green":"静かな間。お互いに笑う。","Pink":"","Text":"[セビョク]あなたこそ"},{"Orange":"","Green":"","Pink":"","Text":"[アリ(ギフンに)]ありがとう。助けてくれて。"},{"Orange":"After Dialogue Screen OFF","Green":"","Pink":"","Text":"[ギフン]生き延びなきゃ意味がないからな..."},{"Orange":"","Green":"","Pink":"数秒後:Spotlight ON","Text":"[ジヨン]ねぇ...やっぱりあんたが生き残って。そして、弟に会いに言ってほしい。"},{"Orange":"","Green":"セリフ後：ジヨンゆっくりピンクマン方面へ。","Pink":"","Text":"[セビョク]ちょっと、待って。何を言っているの？一緒に..."},{"Orange":"Start Voice [銃声SE]","Green":"ピンクマン:銃を向ける　ジヨン打たれたら倒れる。","Pink":"","Text":"[ピンクマン]脱落。"},{"Orange":"After Dialogue Screen OFF","Green":"","Pink":"After Dialogue Lights OFF","Text":"[セビョク]ジヨン!!（泣）"},{"Orange":"","Green":"","Pink":"","Text":"Scene 6: Game 3 ガラス橋(VFX) 【3分】"},{"Orange":"Change Screen [ガラス橋]","Green":"All ステージ裏側待機・動画再生","Pink":"VIDEO PLAYBACK","Text":""},{"Orange":"","Green":"","Pink":"","Text":"Scene 7: Game4 イカゲーム【2分】"},{"Orange":"Screen ON [イカゲーム]","Green":"ギフンvsサンウ、最後の対決","Pink":"All lights ON","Text":"[ピンクマン]ファイナルゲーム「イカゲーム」。相手を制圧した方の勝利です。"},{"Orange":"","Green":"","Pink":"","Text":"格闘"},{"Orange":"","Green":"自分に向かってナイフを向ける","Pink":"","Text":"[サンウ]殺せよ！そうしないと、終わらないだろ？"},{"Orange":"","Green":"","Pink":"","Text":"[ギフン]...。買っても意味がないだろ。こんなやり方じゃ...。"},{"Orange":"","Green":"ギフン：ナイフを捨てる。直後サンウ：自分のお腹を刺して倒れる","Pink":"","Text":"[サンウ]せめて...お母さんに...お金を...。"},{"Orange":"","Green":"","Pink":"","Text":"[フロントマン]勝者、ギフン。"},{"Orange":"","Green":"VIP拍手しながら入場","Pink":"","Text":"[VIP]見事な人間撃でしたね。"},{"Orange":"","Green":"","Pink":"","Text":"[ギフン]こんなの...遊びじゃない！！"},{"Orange":"Screen OFF","Green":"","Pink":"All lights OFF","Text":""},{"Orange":"","Green":"","Pink":"On Lights [ギフン中心に]","Text":"[ナレーター]人は何を失えば、「人間」でなくなるのか。欲望と絶望が交差する先に、勝者履いた。"},{"Orange":"","Green":"","Pink":"","Text":"Scene 8:エンディング"},{"Orange":"Change Screen[エンディング]","Green":"All エンディング・動画再生。呼ばれたらステージへ","Pink":"VIDEO PLAYBACK","Text":""}]

</script>

<script>
const DB_BASE = 'https://couud-dashboard-default-rtdb.firebaseio.com';
const DB_KEY  = 'nunhoa:1';
const POLL_MS = 100;
const DB_URL = `${DB_BASE}/${encodeURIComponent(DB_KEY)}.json`;

let rawPages = [];
try { 
  // JSONデータの制御文字対策
  let jsonText = document.getElementById('pages-data').textContent || '[]';
  // 制御文字（\u000Aなど）を除去
  jsonText = jsonText.replace(/[\u0000-\u001F]+/g, ''); 
  rawPages = JSON.parse(jsonText); 
} catch(e) { 
  rawPages = []; 
  console.error(e); 
}
const pages = Array.isArray(rawPages) ? rawPages : [];

let currentIndex = 0;
let lastRemoteTs = 0;
const elCurrent = document.getElementById('pageCurrent');
const elNext = document.getElementById('pageNext');
const elInterval = document.getElementById('intervalMs'); elInterval.textContent = POLL_MS;

function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderPage(index) {
  index = ((index % pages.length) + pages.length) % pages.length;
  const cur = pages[index];
  const nxt = pages[(index + 1) % pages.length];

  // ページデータが存在しない場合は空表示
  if (!cur) {
    elCurrent.innerHTML = '';
  } else {
    elCurrent.innerHTML = Object.keys(cur)
      .filter(k => k !== 'Text' && cur[k] && cur[k].trim() !== '')
      .map(k => `<div class="block blk-${k}"><div class="text">${escapeHtml(cur[k])}</div></div>`)
      .join('') +
      `<div class="block blk-Text" style="flex-grow:1;"><div class="text">${escapeHtml(cur.Text||'')}</div></div>`;
  }

  if (!nxt) {
    elNext.innerHTML = '';
  } else {
    elNext.innerHTML = `<div class="text">${escapeHtml(nxt.Text||'')}</div>`;
  }
  currentIndex = index;
}

async function writeIndexToFirebase(index){
  try{
    await fetch(DB_URL, {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({index:index, updatedAt:Date.now()})
    });
  }catch(e){console.error(e);}
}

function goNext(){
  const next = (currentIndex + 1) % pages.length;
  renderPage(next);
  writeIndexToFirebase(next);
}
function goPrev(){
  const prev = (currentIndex - 1 + pages.length) % pages.length;
  renderPage(prev);
  writeIndexToFirebase(prev);
}

document.getElementById('nextBtn').addEventListener('click', goNext);
document.getElementById('backBtn').addEventListener('click', goPrev);
window.addEventListener('keydown', e=>{if(e.key==='ArrowRight') goNext(); if(e.key==='ArrowLeft') goPrev();});

async function fetchRemote(){
  try{
    const res = await fetch(DB_URL + '?t=' + Date.now(), {cache:'no-store', mode:'cors'});
    if(!res.ok) return;
    const data = await res.json();
    if(!data) return;
    const remoteIndex = (typeof data.index === 'number') ? data.index : null;
    const remoteTs = (typeof data.updatedAt === 'number') ? data.updatedAt : 0;
    if(remoteTs > lastRemoteTs && remoteIndex !== null && remoteIndex !== currentIndex){
      lastRemoteTs = remoteTs;
      renderPage(remoteIndex);
    }
  }catch(e){console.error(e);}
}

if(pages.length){ renderPage(0); }
setInterval(fetchRemote, POLL_MS);
</script>

</body>
</html>
