<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Aspect Calc</title>
    <style>
        :root {
            --md-sys-color-surface: #1D1B16;
            --md-sys-color-on-surface: #E8E2D9;
            --md-sys-color-primary-container: #FFC107;
            --md-sys-color-on-primary-container: #392E00;
            --md-sys-color-primary: #FFE082;
            --md-sys-color-secondary-container: #2d2923ff;
            --md-sys-color-on-secondary-container: #fff4d3ff;
            --md-sys-color-tertiary-container: #665E40;
            --md-sys-color-on-tertiary-container: #E8E2D9;
            --md-sys-color-error: #ffebe9ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body, html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        .home-btn {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 100;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .home-btn svg { fill: var(--md-sys-color-on-surface); width: 24px; height: 24px; }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            transition: flex-direction 0.3s ease;
        }

        .display-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 40px;
            overflow: hidden;
        }

        #display-text {
            font-size: clamp(2rem, 12vmin, 8rem);
            font-weight: 300;
            text-align: right;
            word-break: break-all;
            width: 100%;
        }

        .buttons-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            padding: 16px;
            flex-grow: 1;
        }

        @media (min-aspect-ratio: 1/1) {
            .container { flex-direction: row; }
            .display-section { width: 50%; height: 100%; }
            .buttons-section { width: 50%; height: 100%; }
        }

        @media (max-aspect-ratio: 1/1) {
            .container { flex-direction: column; }
            .display-section { width: 100%; height: 40%; align-items: flex-end; }
            .buttons-section { width: 100%; height: 60%; }
        }

        button.calc-key {
            border: none;
            border-radius: 24px;
            font-size: 1.6rem;
            font-weight: 500;
            cursor: pointer;
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            transition: filter 0.2s, transform 0.1s;
            height: 100%;
            width: 100%;
        }

        button.calc-key:active { transform: scale(0.96); filter: brightness(1.3); }

        .operator { background-color: var(--md-sys-color-tertiary-container) !important; color: var(--md-sys-color-primary) !important; }
        .equals { background-color: var(--md-sys-color-primary-container) !important; color: var(--md-sys-color-on-primary-container) !important; }
        .clear { color: var(--md-sys-color-error) !important; }

    </style>
</head>
<body>

    <button class="home-btn" onclick="location.href='?close=true'">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </button>

    <div class="container">
        <div class="display-section">
            <div id="display-text">0</div>
        </div>

        <div class="buttons-section">
            <button class="calc-key clear" onclick="clearAll()">AC</button>
            <button class="calc-key operator" onclick="inputOperator('/')">÷</button>
            <button class="calc-key operator" onclick="inputOperator('*')">×</button>
            <button class="calc-key operator" onclick="backspace()">⌫</button>
            
            <button class="calc-key" onclick="inputNum('7')">7</button>
            <button class="calc-key" onclick="inputNum('8')">8</button>
            <button class="calc-key" onclick="inputNum('9')">9</button>
            <button class="calc-key operator" onclick="inputOperator('-')">-</button>
            
            <button class="calc-key" onclick="inputNum('4')">4</button>
            <button class="calc-key" onclick="inputNum('5')">5</button>
            <button class="calc-key" onclick="inputNum('6')">6</button>
            <button class="calc-key operator" onclick="inputOperator('+')">+</button>
            
            <button class="calc-key" onclick="inputNum('1')">1</button>
            <button class="calc-key" onclick="inputNum('2')">2</button>
            <button class="calc-key" onclick="inputNum('3')">3</button>
            <button class="calc-key equals" style="grid-row: span 2;" onclick="calculate()">=</button>
            
            <button class="calc-key" style="grid-column: span 2;" onclick="inputNum('0')">0</button>
            <button class="calc-key" onclick="inputNum('.')">.</button>
        </div>
    </div>

    <script>
        let buffer = "0";
        const display = document.getElementById('display-text');
        const operators = ['+', '-', '*', '/'];

        function updateDisplay() {
            display.innerText = buffer.replace(/\*/g, '×').replace(/\//g, '÷');
        }

        function inputNum(num) {
            if (buffer === "0" && num !== ".") {
                buffer = num;
            } else {
                if (num === '.') {
                    // 最後の数値部分を取得してドットチェック
                    const parts = buffer.split(/[\+\-\*\/]/);
                    if (parts[parts.length - 1].includes('.')) return;
                }
                buffer += num;
            }
            updateDisplay();
        }

        function inputOperator(op) {
            const lastChar = buffer.slice(-1);
            const secondLastChar = buffer.slice(-2, -1);

            // 負の数の入力を許可するロジック
            if (op === '-') {
                // すでに '-' が2つ並ぶのを防ぐ
                if (lastChar === '-') return;
                buffer += op;
            } else {
                // 他の演算子の場合、前の文字が演算子なら置き換える
                if (operators.includes(lastChar)) {
                    // もし演算子が2つ並んでいる（例: *-）なら両方消して置き換え
                    if (operators.includes(secondLastChar)) {
                        buffer = buffer.slice(0, -2) + op;
                    } else {
                        buffer = buffer.slice(0, -1) + op;
                    }
                } else {
                    buffer += op;
                }
            }
            updateDisplay();
        }

        function clearAll() { buffer = "0"; updateDisplay(); }
        function backspace() { 
            buffer = buffer.length > 1 ? buffer.slice(0, -1) : "0"; 
            updateDisplay(); 
        }

        function calculate() {
            try {
                let expr = buffer;
                // 末尾が演算子で終わっている場合は、有効な部分まで削る
                while (operators.includes(expr.slice(-1))) {
                    expr = expr.slice(0, -1);
                }
                if (!expr) return;

                const result = new Function('return ' + expr)();
                if (!isFinite(result)) throw new Error();
                
                // 精度調整：浮動小数点の誤差対策
                buffer = String(Number.isInteger(result) ? result : parseFloat(result.toFixed(10)));
                updateDisplay();
            } catch (e) {
                display.innerText = "Error";
                buffer = "0";
            }
        }
    </script>
</body>
</html>