<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像WebP変換ツール | WebP Converter Online Tool</title>
    <link rel="icon" href="https://search3958.github.io/icons/search3958.svg">
    <meta name="description" content="無料のオンライン画像変換ツール。JPG、PNG、GIFなどの画像をワンクリックで高速にWebP形式に変換します。">
    <meta property="og:title" content="画像フォーマット変換ツール (WebP)">
    <meta property="og:description" content="JPG、PNG、GIFなどの画像をワンクリックで高速にWebP形式に変換します。">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:ital,wght@0,300;1,300&family=M+PLUS+2:wght@400&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
    </script>
    <script type="module">
        import '@material/web/all.js';
        import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';
        document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
     :root{--md-sys-color-primary:color(display-p3 0.126 0 0.797 / 1);--md-sys-color-primary-hover:color(display-p3 0.252 0.157 1 / 1);--md-sys-color-error:color(display-p3 0.677 0 0.021 / 1);--md-sys-color-error-hover:color(display-p3 0.51 0 0.02);--md-ripple-hover-color:#0000;--md-ripple-pressed-color-light:#fff;--md-ripple-pressed-color-error:#f00;--sys-color-background:#f2f2f2;--sys-color-surface:#ffffff;--sys-color-surface-container:#fffb;--sys-color-outline:#e0e0e0;--sys-color-on-background:#090909;--sys-color-on-surface:#2c3e50;--sys-color-on-surface-variant:#b1b1b1;--sys-color-input-background:#fff;--sys-color-input-focus-outline:var(--md-sys-color-primary);--sys-color-placeholder:#6c757d;--sys-color-inactive-button:#dedede;--sys-color-inactive-button-hover:#bababa;--sys-color-result-copy-button:#2ecc71}@media (prefers-color-scheme:dark){:root{--md-sys-color-primary:color(display-p3 0.201 0.249 1 / 1);--md-sys-color-primary-hover:color(display-p3 0.045 0.152 0.814 / 1);--md-sys-color-error:color(display-p3 0.9 0.2 0.1 / 1);--md-sys-color-error-hover:color(display-p3 0.7 0.1 0.05 / 1);--sys-color-background:#121212;--sys-color-surface:#1e1e1e;--sys-color-surface-container:#1e1e1e99;--sys-color-outline:#3a3a3a;--sys-color-on-background:#ffffff;--sys-color-on-surface:#cccccc;--sys-color-on-surface-variant:#787878;--sys-color-input-background:#282828;--sys-color-input-focus-outline:var(--md-sys-color-primary);--sys-color-inactive-button:#3a3a3a;--sys-color-inactive-button-hover:#4a4a4a;--sys-color-result-copy-button:#3498db}}*{font-family:"M PLUS 2",sans-serif;font-weight:400;font-style:normal;line-height:1.5}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:20px;background-color:var(--sys-color-background);min-height:100vh;padding-top:120px}::-webkit-scrollbar{display:none}.container{max-width:1200px;margin:0 auto}.header{color:var(--sys-color-on-background);padding:20px;font-size:2em;position:fixed;z-index:100;top:0;left:0;width:calc(100vw - 24px);background:var(--sys-color-surface-container);backdrop-filter:blur(24px);display:flex;gap:8px}h2,h3{color:var(--sys-color-on-background);margin-top:8px}.selection-group{display:flex;gap:20px;align-items:flex-start;margin-bottom:30px;padding:15px 20px;background-color:var(--sys-color-surface);mask-image:paint(squircle);--squircle-radius:32px;--squircle-smooth:0.4}.selection-box{flex:1;min-width:0}.separator{width:1px;background-color:var(--sys-color-outline);align-self:stretch;margin:0 10px}.btn-group{display:flex;width:100%;overflow:hidden}.btn-group button{flex:1;position:relative;padding:16px;margin:0;cursor:pointer;border:none;border-right:1px solid var(--sys-color-on-surface-variant);background-color:var(--sys-color-inactive-button);--md-ripple-pressed-color:var(--md-ripple-pressed-color-light);color:var(--sys-color-on-surface);font-weight:600;transition:all 0.6s cubic-bezier(.23,.81,0,1);border-radius:8px}.btn-group button:last-child{border-right:none}.btn-group button:hover{flex-grow:1.2;background-color:var(--sys-color-inactive-button-hover)}.btn-group button.active{background-color:var(--md-sys-color-primary);color:white;box-shadow:none;border-radius:26.5px}.btn-group button.active:hover{background-color:var(--md-sys-color-primary-hover)}.input-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}#fileInput{display:none}.drop-area{width:calc(100% - 12px);min-height:80px;padding:24px;cursor:pointer;text-align:center;display:flex;flex-direction:column;justify-content:center;align-items:center;font-family:'M PLUS 2',sans-serif;box-sizing:border-box;margin:6px;margin-bottom:0px;transition:all 0.2s ease;background:var(--sys-color-input-background);color:var(--sys-color-placeholder);mask-image:paint(squircle);--squircle-radius:38px;--squircle-smooth:0.43}.drop-area.highlight{border-color:var(--md-sys-color-primary);color:var(--md-sys-color-primary);background:#e6ffe6}@media (prefers-color-scheme:dark){.drop-area.highlight{background:#1e281e}}#clearButton{padding:16px 24px;border:none;mask-image:paint(squircle);--squircle-radius:32px;--squircle-smooth:0.3;cursor:pointer;font-weight:600;background-color:var(--md-sys-color-error);color:white;transition:background-color 0.2s;--md-ripple-pressed-color:var(--md-ripple-pressed-color-error)}#clearButton:hover{background-color:var(--md-sys-color-error-hover)}.update-controls{display:flex;align-items:center;gap:20px;margin:20px 0 30px 0;justify-content:flex-start}#downloadAllZipButton{padding:16px 24px;border:none;mask-image:paint(squircle);--squircle-radius:32px;--squircle-smooth:0.3;background-color:var(--md-sys-color-primary);color:white;font-weight:700;cursor:pointer;transition:all 0.2s;--md-ripple-pressed-color:#fff}#downloadAllZipButton:hover{background-color:var(--md-sys-color-primary-hover)}#downloadAllZipButton:disabled{background-color:var(--sys-color-inactive-button);color:var(--sys-color-on-surface-variant);cursor:not-allowed}.result-area{padding:0;border-radius:0;background-color:transparent;box-shadow:none}#resultCards{display:flex;flex-wrap:nowrap;gap:8px;padding:0;min-height:50px;overflow:scroll;mask-image:paint(squircle);--squircle-radius:38px;--squircle-smooth:0.43}.result-card{width:calc(33.33% - 14px);box-sizing:border-box;padding:20px;background-color:white;mask-image:paint(squircle);--squircle-radius:20px;--squircle-smooth:0.4;color:var(--sys-color-on-surface);display:flex;flex-direction:column;align-items:center;flex-shrink:0}@media (prefers-color-scheme:dark){.result-card{background-color:#ffffff;color:#333333}}.card-image{max-width:100%;max-height:150px;object-fit:contain;border-radius:8px;margin-bottom:10px}.card-filename{font-weight:600;margin-bottom:5px;text-align:center;word-break:break-all}.card-info{font-size:0.9em;margin-bottom:15px;text-align:center}.download-btn{display:inline-block;padding:16px 24px;border:none;border-radius:100px;background-color:var(--md-sys-color-primary);color:white;text-decoration:none;cursor:pointer;transition:background-color 0.2s;margin-top:10px}.download-btn:hover{background-color:var(--md-sys-color-primary-hover)}#errorDisplay{color:var(--md-sys-color-error);font-weight:600}@media (max-width:1000px){.result-card{width:calc(50% - 10px)}}@media (max-width:768px){body{padding:10px;padding-top:120px}.selection-group{flex-direction:column;gap:10px;padding:15px}.separator{width:100%;height:1px;margin:10px 0}.selection-box{width:100%}.update-controls{flex-direction:column;align-items:stretch;gap:10px}.result-card{width:100%}}
    </style>

    <script>
    if ("paintWorklet" in CSS) {
        // paint workletのコードは変更なし
        const workletCode = `
            const drawSquircle=(ctx,geom,radii,smooth,lineWidth,color)=>{const defaultFill=color;const lineWidthOffset=lineWidth/2;ctx.beginPath();ctx.lineTo(radii[0],lineWidthOffset);ctx.lineTo(geom.width-radii[1],lineWidthOffset);ctx.bezierCurveTo(geom.width-radii[1]/smooth,lineWidthOffset,geom.width-lineWidthOffset,radii[1]/smooth,geom.width-lineWidthOffset,radii[1]);ctx.lineTo(geom.width-lineWidthOffset,geom.height-radii[2]);ctx.bezierCurveTo(geom.width-lineWidthOffset,geom.height-radii[2]/smooth,geom.width-radii[2]/smooth,geom.height-lineWidthOffset,geom.width-radii[2],geom.height-lineWidthOffset);ctx.lineTo(radii[3],geom.height-lineWidthOffset);ctx.bezierCurveTo(radii[3]/smooth,geom.height-lineWidthOffset,lineWidthOffset,geom.height-radii[3]/smooth,lineWidthOffset,geom.height-radii[3]);ctx.lineTo(lineWidthOffset,radii[0]);ctx.bezierCurveTo(lineWidthOffset,radii[0]/smooth,radii[0]/smooth,lineWidthOffset,radii[0],lineWidthOffset);ctx.closePath();if(lineWidth){ctx.strokeStyle=defaultFill;ctx.lineWidth=lineWidth;ctx.stroke()}else{ctx.fillStyle=defaultFill;ctx.fill()}};class SquircleClass{static get contextOptions(){return{alpha:true}}static get inputProperties(){return["--squircle-radius","--squircle-radius-top-left","--squircle-radius-top-right","--squircle-radius-bottom-right","--squircle-radius-bottom-left","--squircle-smooth","--squircle-outline","--squircle-fill"]}paint(ctx,geom,properties){const smoothRatio=10;const distanceRatio=1.8;const squircleSmooth=parseFloat(properties.get("--squircle-smooth")*smoothRatio);const individualRadiiProps=SquircleClass.inputProperties.slice(1,5);let squircleRadii=individualRadiiProps.map(prop=>{const value=properties.get(prop);return value?parseInt(value,10)*distanceRatio:NaN});let shorthand_R;if(squircleRadii.some(isNaN)){const radiusRegex=/([0-9]+[a-z%]*)/g;const radius_shorthand=properties.get("--squircle-radius").toString();const matches=radius_shorthand.match(radiusRegex);if(matches){shorthand_R=matches.map(val=>parseInt(val,10)*distanceRatio);while(shorthand_R.length<4){if(shorthand_R.length===1){shorthand_R.push(shorthand_R[0])}else if(shorthand_R.length===2){shorthand_R=[shorthand_R[0],shorthand_R[1],shorthand_R[0],shorthand_R[1]]}else if(shorthand_R.length===3){shorthand_R=[shorthand_R[0],shorthand_R[1],shorthand_R[2],shorthand_R[1]]}}}else{const defaultRadius=squircleRadii.every(isNaN)?8*distanceRatio:0;shorthand_R=[defaultRadius,defaultRadius,defaultRadius,defaultRadius]}}squircleRadii=squircleRadii.map((val,i)=>isNaN(val)?shorthand_R[i]:val);const squrcleOutline=parseFloat(properties.get("--squircle-outline"),10);const squrcleColor=properties.get("--squircle-fill").toString();const isSmooth=()=>{if(typeof properties.get("--squircle-smooth")[0]!=="undefined"){if(squircleSmooth===0){return 1}return squircleSmooth}else{return 10}};const isOutline=()=>{if(squrcleOutline){return squrcleOutline}else{return 0}};const isColor=()=>{if(squrcleColor){return squrcleColor}else{return"#f45"}};const maxRadius=Math.max(...squircleRadii);if(maxRadius<geom.width/2&&maxRadius<geom.height/2){drawSquircle(ctx,geom,squircleRadii,isSmooth(),isOutline(),isColor())}else{const minRadius=Math.min(geom.width/2,geom.height/2);drawSquircle(ctx,geom,squircleRadii.map(()=>minRadius),isSmooth(),isOutline(),isColor())}}}if(typeof registerPaint!=="undefined"){registerPaint("squircle",SquircleClass)}
        `;
        const blob = new Blob([workletCode], { type: 'application/javascript' });
        const blobURL = URL.createObjectURL(blob);
        CSS.paintWorklet.addModule(blobURL);
    }
    </script>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="https://search3958.github.io">
                <svg width="57" height="57" viewBox="0 0 14 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#paint0_angular_1200_9_clip_path)" data-figma-skip-parse="true"><g transform="matrix(4.17232e-10 -0.009 -0.009 -4.17232e-10 7 14)"><foreignObject x="-1111.11" y="-1111.11" width="2222.22" height="2222.22"><div xmlns="http://www.w3.org/1999/xhtml" style="background:conic-gradient(from 90deg,rgba(0, 17, 88, 1) 0deg,rgba(0, 38, 190, 1) 181.711deg,rgba(0, 95, 255, 1) 290.751deg,rgba(145, 216, 255, 1) 349.598deg,rgba(255, 255, 255, 1) 360deg);height:100%;width:100%;opacity:1"></div></foreignObject></g></g><rect width="14" height="14" rx="7" transform="matrix(0 1 1 0 0 5)" data-figma-gradient-fill="{&#34;type&#34;:&#34;GRADIENT_ANGULAR&#34;,&#34;stops&#34;:[{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.069023430347442627,&#34;b&#34;:0.34511718153953552,&#34;a&#34;:1.0},&#34;position&#34;:0.0},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.14902342855930328,&#34;b&#34;:0.74511718750,&#34;a&#34;:1.0},&#34;position&#34;:0.50475275516510010},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.37382256984710693,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:0.80764156579971313},{&#34;color&#34;:{&#34;r&#34;:0.57208782434463501,&#34;g&#34;:0.85023075342178345,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:0.97110533714294434},{&#34;color&#34;:{&#34;r&#34;:1.0,&#34;g&#34;:1.0,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:1.0}],&#34;stopsVar&#34;:[{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.069023430347442627,&#34;b&#34;:0.34511718153953552,&#34;a&#34;:1.0},&#34;position&#34;:0.0},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.14902342855930328,&#34;b&#34;:0.74511718750,&#34;a&#32;:1.0},&#34;position&#34;:0.50475275516510010},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.37382256984710693,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:0.80764156579971313},{&#34;color&#34;:{&#34;r&#34;:0.57208782434463501,&#34;g&#34;:0.85023075342178345,&#34;b&#34;:1.0,&#34;a&#32;:1.0},&#34;position&#34;:0.97110533714294434},{&#34;color&#34;:{&#34;r&#34;:1.0,&#34;g&#34;:1.0,&#34;b&#34;:1.0,&#34;a&#32;:1.0},&#34;position&#34;:1.0}],&#34;transform&#34;:{&#34;m00&#34;:8.3446485632521217e-07,&#34;m01&#34;:-18.0,&#34;m02&#34;:15.999999046325684,&#34;m10&#34;:-18.0,&#34;m11&#34;:-8.3446400367392926e-07,&#34;m12&#34;:23.0},&#34;opacity&#34;:1.0,&#34;blendMode&#34;:&#34;NORMAL&#34;,&#34;visible&#34;:true}"/>
                <g clip-path="url(#paint1_angular_1200_9_clip_path)" data-figma-skip-parse="true"><g transform="matrix(4.17233e-10 0.009 0.009 -4.17234e-10 7 5)"><foreignObject x="-1111.11" y="-1111.11" width="2222.22" height="2222.22"><div xmlns="http://www.w3.org/1999/xhtml" style="background:conic-gradient(from 90deg,rgba(0, 17, 88, 1) 0deg,rgba(0, 38, 190, 1) 181.711deg,rgba(0, 95, 255, 1) 290.751deg,rgba(145, 216, 255, 1) 349.598deg,rgba(255, 255, 255, 1) 360deg);height:100%;width:100%;opacity:1"></div></foreignObject></g></g><rect width="14" height="14" rx="7" transform="matrix(0 1 1 0 0 0)" data-figma-gradient-fill="{&#34;type&#34;:&#34;GRADIENT_ANGULAR&#34;,&#34;stops&#34;:[{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.069023430347442627,&#34;b&#34;:0.34511718153953552,&#34;a&#34;:1.0},&#34;position&#34;:0.0},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.14902342855930328,&#34;b&#34;:0.74511718750,&#34;a&#34;:1.0},&#34;position&#34;:0.50475275516510010},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.37382256984710693,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:0.80764156579971313},{&#34;color&#34;:{&#34;r&#34;:0.57208782434463501,&#34;g&#34;:0.85023075342178345,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:0.97110533714294434},{&#34;color&#34;:{&#34;r&#34;:1.0,&#34;g&#34;:1.0,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:1.0}],&#34;stopsVar&#34;:[{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.069023430347442627,&#34;b&#34;:0.34511718153953552,&#34;a&#32;:1.0},&#34;position&#34;:0.0},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.14902342855930328,&#34;b&#34;:0.74511718750,&#34;a&#34;:1.0},&#34;position&#34;:0.50475275516510010},{&#34;color&#34;:{&#34;r&#34;:0.0,&#34;g&#34;:0.37382256984710693,&#34;b&#34;:1.0,&#34;a&#32;:1.0},&#34;position&#34;:0.80764156579971313},{&#34;color&#34;:{&#34;r&#34;:0.57208782434463501,&#34;g&#34;:0.85023075342178345,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:0.97110533714294434},{&#34;color&#34;:{&#34;r&#34;:1.0,&#34;g&#34;:1.0,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:1.0}],&#34;transform&#34;:{&#34;m00&#34;:8.3446667531461571e-07,&#34;m01&#34;:18.000001907348633,&#34;m02&#34;:-2.0000011920928955,&#34;m10&#34;:18.000001907348633,&#34;m11&#34;:-8.3446792586983065e-07,&#34;m12&#34;:-4.0},&#34;opacity&#34;:1.0,&#34;blendMode&#34;:&#34;NORMAL&#34;,&#34;visible&#34;:true}"/>
                <rect width="14" height="14" rx="7" transform="matrix(0 1 1 0 0 5)" fill="url(#paint2_radial_1200_9)" fill-opacity="0.9" style="mix-blend-mode:screen"/>
                <defs>
                <clipPath id="paint0_angular_1200_9_clip_path"><rect width="14" height="14" rx="7" transform="matrix(0 1 1 0 0 5)"/></clipPath><clipPath id="paint1_angular_1200_9_clip_path"><rect width="14" height="14" rx="7" transform="matrix(0 1 1 0 0 0)"/></clipPath><radialGradient id="paint2_radial_1200_9" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(7.5 7) rotate(180) scale(7.5)">
                <stop offset="0.504753"/>
                <stop offset="0.692311" stop-color="#001B4A"/>
                <stop offset="0.807642" stop-color="#0043B2"/>
                <stop offset="0.971105" stop-color="#92D9FF"/>
                <stop offset="1" stop-color="#F3FFBF"/>
                </radialGradient>
                </defs>
                </svg>
            </a>
            WebP変換ツール
        </div>

        <div class="selection-group">
            <div class="selection-box">
                <h3>出力形式</h3>
                <div class="btn-group" id="formatGroup">
                    <button data-format="webp" class="active">WebP<md-ripple></md-ripple></button>
                    <button data-format="jpeg">JPEG<md-ripple></md-ripple></button>
                </div>
            </div>
            <div class="separator"></div>
            <div class="selection-box">
                <h3>変換品質</h3>
                <div class="btn-group" id="qualityGroup">
                    <button data-quality="0.9" class="active">高画質<md-ripple></md-ripple></button>
                    <button data-quality="0.75">標準<md-ripple></md-ripple></button>
                    <button data-quality="0.5">軽量<md-ripple></md-ripple></button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="input-header">
                <h2>ファイルを選択</h2>
                <button id="clearButton">クリア<md-ripple></md-ripple></button>
            </div>
            
            <input type="file" id="fileInput" accept="image/jpeg, image/png, image/gif" multiple>
            <label for="fileInput" class="drop-area" id="dropArea">
                ファイルをここにドラッグ＆ドロップ、またはクリックして選択
                <p id="initialMessage">選択されたファイルはありません。</p>
            </label>
        </div>

        <div class="update-controls">
            <button id="downloadAllZipButton" disabled>全ファイルをZIPでダウンロード</button>
        </div>

        <div class="result-area">
            <h2>変換結果</h2>
            <div id="resultCards">
                </div>
            <p id="errorDisplay" style="color: var(--md-sys-color-error); margin-top: 10px; font-weight: 600;"></p>
        </div>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6151036058675874"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-6151036058675874"
     data-ad-slot="2183688121"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
    </div>
    
    <script>const formatGroup = document.getElementById('formatGroup');const qualityGroup = document.getElementById('qualityGroup');const fileInput = document.getElementById('fileInput');const dropArea = document.getElementById('dropArea');const initialMessage = document.getElementById('initialMessage');const clearButton = document.getElementById('clearButton');const resultCards = document.getElementById('resultCards');const errorDisplay = document.getElementById('errorDisplay');const downloadAllZipButton = document.getElementById('downloadAllZipButton');let selectedFiles = [];let outputFormat = 'webp';let quality = 0.9;let convertedDataUrls = [];function getBaseName(fileName){const parts = fileName.split('.');if(parts.length > 1){parts.pop();}return parts.join('.');}function convertImageToFormat(file,format,quality){return new Promise((resolve,reject)=>{const reader = new FileReader();reader.onload =(event)=>{const img = new Image();img.onload =()=>{try{const canvas = document.createElement('canvas');canvas.width = img.width;canvas.height = img.height;const ctx = canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0);const mimeType = format === 'webp' ? 'image/webp':'image/jpeg';const dataURL = canvas.toDataURL(mimeType,quality);if(dataURL === 'data:,'){reject(new Error('このブラウザでは指定された形式への変換をサポートしていません。'));return;}fetch(dataURL).then(res => res.blob()).then(blob => resolve({dataURL,blob})).catch(e => reject(new Error('DataURLからBlobへの変換に失敗しました:' + e.message)));}catch(e){reject(new Error('変換中に予期せぬエラーが発生しました:' + e.message));}};img.onerror =()=>{reject(new Error('画像の読み込みに失敗しました。ファイルが壊れていないか確認してください。'));};img.src = event.target.result;};reader.onerror =()=>{reject(new Error('ファイルの読み込みに失敗しました。'));};reader.readAsDataURL(file);});}function createResultCard(file,dataUrl,outputFileName,quality){const card = document.createElement('div');card.className = 'result-card';const img = document.createElement('img');img.className = 'card-image';img.src = dataUrl;img.alt = outputFileName;const filenameP = document.createElement('p');filenameP.className = 'card-filename';filenameP.textContent = outputFileName;const infoP = document.createElement('p');infoP.className = 'card-info';infoP.textContent = `品質:${Math.round(quality * 100)}% / 形式:${outputFormat.toUpperCase()}`;const downloadLink = document.createElement('a');downloadLink.className = 'download-btn';downloadLink.href = dataUrl;downloadLink.download = outputFileName;downloadLink.textContent = 'ダウンロード';card.appendChild(img);card.appendChild(filenameP);card.appendChild(infoP);card.appendChild(downloadLink);return card;}async function startConversion(){errorDisplay.textContent = '';resultCards.innerHTML = '';downloadAllZipButton.disabled = true;convertedDataUrls = [];if(selectedFiles.length === 0){resultCards.innerHTML = '<p style="width:100%;text-align:center;">ファイルを選択またはドラッグ＆ドロップしてください。</p>';downloadAllZipButton.textContent = `全ファイルをZIPでダウンロード`;return;}resultCards.innerHTML = `<p style="width:100%;text-align:center;">${selectedFiles.length}個のファイルを変換中です...</p>`;downloadAllZipButton.textContent = `変換中...`;let successCount = 0;const extension = outputFormat === 'webp' ? 'webp':'jpg';const conversionPromises = selectedFiles.map(async(file)=>{const baseName = getBaseName(file.name);const outputFileName = `${baseName}.${extension}`;try{const{dataURL,blob}= await convertImageToFormat(file,outputFormat,quality);return{file,dataURL,blob,outputFileName,success:true};}catch(e){return{file,success:false,errorMessage:e.message};}});const results = await Promise.all(conversionPromises);resultCards.innerHTML = '';let failedFiles = [];results.forEach(res =>{if(res.success){const card = createResultCard(res.file,res.dataURL,res.outputFileName,quality);resultCards.appendChild(card);convertedDataUrls.push({name:res.outputFileName,blob:res.blob});successCount++;}else{failedFiles.push(`${res.file.name}(${res.errorMessage})`);}});if(failedFiles.length > 0){errorDisplay.textContent = `以下のファイルの変換に失敗しました:${failedFiles.join(',')}`;}if(successCount > 0){downloadAllZipButton.textContent = `${successCount}個のファイルをZIPでダウンロード`;downloadAllZipButton.disabled = false;}else{resultCards.innerHTML = `<p style="width:100%;text-align:center;">全てのファイルの変換に失敗しました。</p>`;downloadAllZipButton.textContent = `全ファイルをZIPでダウンロード`;}}async function handleZipDownload(){if(convertedDataUrls.length === 0)return;downloadAllZipButton.disabled = true;const originalText = downloadAllZipButton.textContent;downloadAllZipButton.textContent = 'ZIPファイルを作成中...';const zip = new JSZip();convertedDataUrls.forEach(item =>{zip.file(item.name,item.blob);});try{const content = await zip.generateAsync({type:"blob"});const qualityLabel = Math.round(quality * 100);const zipFileName = `images_converted_${outputFormat}_q${qualityLabel}.zip`;const downloadLink = document.createElement('a');downloadLink.href = URL.createObjectURL(content);downloadLink.download = zipFileName;document.body.appendChild(downloadLink);downloadLink.click();document.body.removeChild(downloadLink);}catch(e){errorDisplay.textContent = 'ZIPファイルの作成中にエラーが発生しました:' + e.message;}finally{downloadAllZipButton.textContent = originalText;downloadAllZipButton.disabled = false;}}function updateFileState(files){selectedFiles = Array.from(files);if(selectedFiles.length > 0){initialMessage.textContent = `${selectedFiles.length}個のファイルが選択されました。`;}else{initialMessage.textContent = '選択されたファイルはありません。';}startConversion();}function clearFile(){selectedFiles = [];fileInput.value = '';updateFileState([]);resultCards.innerHTML = '<p style="width:100%;text-align:center;">ファイルを選択またはドラッグ＆ドロップしてください。</p>';downloadAllZipButton.textContent = `全ファイルをZIPでダウンロード`;downloadAllZipButton.disabled = true;errorDisplay.textContent = '';}const selectionHandler =(e)=>{if(e.target.tagName === 'BUTTON'){const group = e.currentTarget;group.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));e.target.classList.add('active');if(group.id === 'formatGroup'){outputFormat = e.target.dataset.format;}else if(group.id === 'qualityGroup'){quality = parseFloat(e.target.dataset.quality);}startConversion();}};formatGroup.addEventListener('click',selectionHandler);qualityGroup.addEventListener('click',selectionHandler);fileInput.addEventListener('change',(e)=>{const newFiles = Array.from(e.target.files);const combinedFiles = [...selectedFiles,...newFiles];e.target.value = '';updateFileState(combinedFiles);});['dragenter','dragover','dragleave','drop'].forEach(eventName =>{dropArea.addEventListener(eventName,(e)=>{e.preventDefault();e.stopPropagation();},false);});['dragenter','dragover'].forEach(eventName =>{dropArea.addEventListener(eventName,()=> dropArea.classList.add('highlight'),false);});['dragleave','drop'].forEach(eventName =>{dropArea.addEventListener(eventName,()=> dropArea.classList.remove('highlight'),false);});dropArea.addEventListener('drop',(e)=>{const dt = e.dataTransfer;const newFiles = Array.from(dt.files);if(newFiles.length > 0){const combinedFiles = [...selectedFiles,...newFiles];updateFileState(combinedFiles);}},false);downloadAllZipButton.addEventListener('click',handleZipDownload);clearButton.addEventListener('click',clearFile);document.addEventListener('DOMContentLoaded',()=>{clearFile();});
</script>
</body>
</html>